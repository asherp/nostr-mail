
volumes:
  cargo-cache:
  target-cache:

services:
  email-server:
    image: nostrmail/dev
    build:
      context: ./mock-email
      dockerfile: ../dev.Dockerfile
    ports:
      - "2525:2525"  # SMTP port
      - "1143:1143"  # IMAP port
    volumes:
      - type: bind
        source: ./mock-email
        target: /app
      - cargo-cache:/root/.cargo/registry
      - cargo-cache:/root/.cargo/git
      - target-cache:/app/target
    container_name: mock-email-server
    command: ["cargo", "watch", "-q", "-c", "-w", "src", "-x", "run -- --smtp-port 2525 --imap-port 1143 --log-level info"]
  
  relay-server:
    image: nostrmail/dev
    build:
      context: ./mock-relay
      dockerfile: ../dev.Dockerfile
    ports:
      - "8080:8080"  # WebSocket port
    volumes:
      - type: bind
        source: ./mock-relay
        target: /app
      - cargo-cache:/root/.cargo/registry
      - cargo-cache:/root/.cargo/git
      - target-cache:/app/target
    container_name: mock-relay-server
    command: ["cargo", "watch", "-q", "-c", "-w", "src", "-x", "run --bin mock-relay -- --generate-fake-events 10 --seed 0 --output-events events.json --port 8080"]

  http-server:
    build:
      context: ./tauri-app/backend
      dockerfile: Dockerfile
    ports:
      - "1420:1420"  # HTTP API port
    volumes:
      - type: bind
        source: ./tauri-app/backend
        target: /app
      - cargo-cache:/root/.cargo/registry
      - cargo-cache:/root/.cargo/git
      - target-cache:/app/target
    container_name: nostr-mail-http-server
    command: ["cargo", "watch", "-q", "-c", "-w", "src", "-x", "run --bin http-server --release"]
    environment:
      - RUST_LOG=info

  frontend:
    build:
      context: ./tauri-app/frontend
      dockerfile: Dockerfile
    ports:
      - "8081:8080"  # Frontend web server port (8081 to avoid conflict with relay-server on 8080)
    container_name: nostr-mail-frontend

  glossia:
    build:
      context: ./glossia
      dockerfile: Dockerfile.dev
    volumes:
      - type: bind
        source: ./glossia
        target: /app
      - cargo-cache:/root/.cargo/registry
      - cargo-cache:/root/.cargo/git
      - target-cache:/app/target
    container_name: glossia
    # Default: run with cargo watch for hot reloading
    # Override with: docker compose run --rm glossia cargo run --bin glossia -- "your text here"
    command: ["cargo", "watch", "-q", "-c", "-w", "src", "-x", "run --bin glossia --"]

  glossia-prod:
    build:
      context: ./glossia
      dockerfile: Dockerfile
    container_name: glossia-prod
    # Usage: docker compose run --rm glossia-prod cargo run --bin glossia -- "your text here"
    # Or: docker compose run --rm glossia-prod (runs default example)


